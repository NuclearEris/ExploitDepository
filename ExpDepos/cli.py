#!/usr/bin/env python
# -*- coding:UTF-8 -*-

"""
@Author: Castiel
@Email:  ca3tie1@gmail.com
@Blog:   https://ca3tie1.github.io
@Git:    https://github.com/ca3tie1
@Wechat: Ca5tie1
@Date:   2021/3/13 12:07
"""

import os
import sys

try:
    import ExpDepos
except ImportError:
    sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), os.path.pardir)))

from ExpDepos.libs.core.common.Common import *
from ExpDepos.libs.core.ModuleLoader import ModuleLoader
from ExpDepos.libs.core.base.Fingerprint import loadFingerprints
from ExpDepos.libs.core.base.ExceptionBase import ExpDeposException
from console import consoleShell


def cli_init():
    # 初始化环境
    env_init()
    # 解析命令行参数
    parse_options()


def module_init():
    # 初始化模块
    env.modules = ModuleLoader.loadAllModules()
    console.info("模块初始化完成, 共加载: {0} 个模块.".format(len(env.modules)))
    # 初始化指纹库
    env.fps = loadFingerprints()
    console.info("指纹库初始化完成, 共加载: {0} 个指纹信息.".format(len(env.fps)))


def cli_run():
    show_banner()
    cli_init()
    # 初始化模块
    module_init()
    if env.CliOptions.list:
        ModuleLoader.list_modules(env.CliOptions.list)
    elif env.CliOptions.console:
        console.info("正在启动Console控制台...\n")
        consoleShell().cmdloop()
    else:
        run_module()


def run_module():
    result = ModuleLoader.run_module(env.CliOptions.module, env.CliOptions)
    if result.is_success():
        console.success(result.message, "\n" + str(result.data) if result.data else "")
    else:
        console.failed(result.message, "\n" + str(result.data) if result.data else "")


if __name__ == "__main__":
    try:
        cli_run()
    except ExpDeposException as e:
        console.error(e.args[0])
    except KeyboardInterrupt:
        pass
    except Exception as e:
        console.exception(repr(e))
    finally:
        pass
