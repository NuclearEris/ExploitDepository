#!/usr/bin/env python

"""
@Author: Castiel
@Email:  ca3tie1@gmail.com
@Blog:   https://ca3tie1.github.io
@Git:    https://github.com/ca3tie1
@Wechat: Ca5tie1
@Date:   2021/3/8 16:22
"""

from ExpDepos.libs.core.base.ExceptionBase import *
from ExpDepos.libs.core.base.OptionsBase import *
from ExpDepos.libs.core.common.Common import *


class ExploitBase(object):
    """
    Exp基类，用于定义每个exp默认方法及规则
    """
    NAME = None  # Exp名称
    APP_NAME = None  # 漏洞应用名称
    APP_VERSION = None  # 漏洞对应版本，版本区间中间使用"-"符号连接
    VERSION = 1  # 版本号，默认1
    SPEC = None  # 模块SPEC，无需自定义，加载时候自动设置

    def __init__(self):
        # 用于存储EXP额外选项
        self.OPTIONS = dict()
        self.OPTIONS["HOST"] = OptString(None, description="目标地址 (可选IP端口或URL地址)", require=True)
        if hasattr(self, "_options") \
                and len(self._options()) > 0:
            # 将用户自定义选项名全部转换为小写，以便在命令行使用-P或者--options选项传入
            self.OPTIONS.update({key.lower(): value for key, value in self._options().items()})
        # 目标指纹信息
        self.FINGERPRINT = None

        self.opt_parse = None

    def fingerprint(self):
        """
        @function   识别目标指纹信息
        :return:    指纹信息实例
        """
        raise NotImplementedError

    def help(self):
        """
        @function   显示用户自定义参数帮助信息
        :return:
        """
        console.info("{0} 模块参数帮助.".format(self.Name))
        options = self._options()
        if len(options) == 0:
            console.info("模块 {0} 暂无用户自定义参数信息.")
        console.debug("获取模块 {0} 用户自定义选项信息 {1}".format(self.Name, options.keys()))
        self.opt_parse = self.get_parse(options)
        console.print("")
        self.opt_parse.print_help()

    def get_parse(self, options):
        opt_parse = argparse.ArgumentParser(prog=self.SPEC, conflict_handler='resolve', add_help=False,
                                            usage="ExpDepos -H host -M {0} [-p,--options] [Module Options]"
                                            .format(format_module(self.SPEC)))
        module_opt_group = opt_parse.add_argument_group("Module Options")
        for key in options.keys():
            module_opt_group.add_argument("--" + key.lower(),
                                          help=options[key].description,
                                          required=options[key].require)

        return opt_parse

    def parse_options(self, source):
        if source is None and len(self._options()) > 0:
            raise ExpDeposeErrorException("模块缺少必要参数 {0}. 请使用[bold cyan]-P[/bold cyan]"
                                          "或者[bold cyan]--options[/bold cyan]选项提供."
                                          .format([key.lower() for key in self._options().keys()
                                                   if self.OPTIONS[key.lower()].require is True]))
        if not self.opt_parse:
            self.opt_parse = self.get_parse(self._options())
        return self.opt_parse.parse_args(source.split())

    def set_option(self, key, value):
        if key not in self.OPTIONS:
            raise ExpDeposValidationException("无法找到选项 {} 请确认该选项是否存在".format(key))
        self.OPTIONS[key].__set__("", value)

    def get_option(self, key):
        if key not in self.OPTIONS:
            raise ExpDeposValidationException("无法找到选项 '{}' 请确认选项是否配置".format(key))
        return self.OPTIONS[key].value

    def _options(self):
        """
        @function   Exploit模块选项设置
        :return:
        """
        raise NotImplementedError

    def _verify(self):
        """
        @function   以exp的verify模式验证目标漏洞是否存在并返回
        :return:    Response
        """
        raise NotImplementedError

    def _exploit(self):
        """
        @function   以exp的exploit模式进行漏洞检测利用并返回
        :return:    Response
        """
        raise NotImplementedError

    def _clean(self):
        """
        @function   日志清理
        :return:    Response
        """
        raise NotImplementedError

    def run(self, Module="Verify"):
        """
        @function   调用入口
        :return:
        """
        # console.debug("Option username is :{}".format(self.get_option("UserName")))
        # if self.OPTIONS["Target"] is None:
        #     console.debug("Test [bold red]debug[/]", "This debug message")
        #     console.info("Test info")
        #     console.success("Test success")
        #     console.failed("Test failed")
        #     console.warning("Test warning")
        #     console.error("Test error")
        #     try:
        #         print(1 / 0)
        #     except Exception as e:
        #         console.exception(repr(e))
        #     return False
