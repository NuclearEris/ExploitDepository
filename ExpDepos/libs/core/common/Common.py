#!/usr/bin/env python

"""
@Author: Castiel
@Email:  ca3tie1@gmail.com
@Blog:   https://ca3tie1.github.io
@Git:    https://github.com/ca3tie1
@Wechat: Ca5tie1
@Date:   2021/3/13 11:21
"""

import os
import random
import sys
import argparse
import pyfiglet
from ExpDepos.libs.core.common.Console import Console
from ExpDepos.config.config import Config
from ExpDepos.libs.core.AttribDict import AttribDict

# 终端信息输出统一使用rich的Logging Handler
console = Console()
env = AttribDict()


def Root_Path():
    """
    获取程序根目录路径

    :return: string 根目录路径值
    """
    return os.path.abspath(os.path.dirname(os.path.abspath(__file__)) + "/../../../../".replace('/', os.sep))


def show_banner():
    """
    显示banner信息

    :return:
    """
    console.print("")
    fonts = ["big", "roman", "slant", "standard", "starwars",
             "univers", "banner4", "epic"]
    banner = pyfiglet.Figlet(font=fonts[random.randrange(len(fonts))], width=200)
    console.print(banner.renderText("ExpDepos"))
    console.print(f"\t\t\t\t\t=[ [bold yellow]ExploitDepository[/] [green]{Config['VERSION']}[/]\t]")
    console.print(f"\t\t\t\t\t=[ [bold yellow]By[/] [bold red]Castiel[/] at {Config['RELEASE_DATE']}\t\t]")
    console.print("")


def show_version():
    """
    显示系统版本号并退出

    :return:
    """
    show_banner()
    console.print(f"ExpDepos Version: \"{Config['VERSION']}\"")
    exit()


def format_module(module_spec):
    """
    格式化模块显示名
    将符号"."替换为文件系统分隔符

    :param module_spec: 模块SPEC或模块路径
    :return: 格式化后的模块显示名
    """
    return module_spec.replace(".", os.sep)


def bool2mark(require):
    """
    将bool类型转换为标记字符串

    :param require:
    :return:
    """
    if require is True:
        return "[bold dark_red]Yes[/bold dark_red]"
    return ""


def none2str(obj):
    """
    将None类型转换为字符串

    :param obj:
    :return:
    """
    if obj is None or obj == "":
        return "[bold orange1]None[/bold orange1]"
    return obj


def check_update():
    """
    检查更新并退出

    :return:
    """
    console.info("update")
    exit()


def envConfig_init():
    """
    将系统配置信息加载到env.Config中

    :return:
    """
    console.debug("将系统配置信息设置到env中")
    env.Config = AttribDict()
    for key, value in Config.items():
        setattr(env.Config, key, value)


def set_verbose(verbose):
    """
    设置信息输出等级

    :param verbose: int 需要设置的信息输出等级值
    :return:
    """
    console.msgLevel = verbose
    console.debug(f"设置verbose为: {verbose}")


def envArgs_init(args):
    """
    将解析到命令行参数设置到环境变量env.CliOptions中

    :param args: argparse 解析后的Namespace对象
    :return:
    """
    env.CliOptions = AttribDict()
    # 解析命令函参数
    # 存储命令行参数值到env中
    console.debug("解析到命令行参数: ", args)
    console.debug("将命令行参数信息设置到env中")
    for key, value in vars(args).items():
        setattr(env.CliOptions, key, value)


def env_init():
    """
    初始化环境信息

    :return:
    """
    # 初始化命令行参数
    args = parse_cliArgs()
    # 设置verbose
    set_verbose(args.verbose)
    console.info("初始化环境...")
    # 设置环境变量
    envArgs_init(args)
    envConfig_init()


def parse_cliArgs(source=None):
    """
    解析命令行参数

    :param source: 参数解析源，默认命令行不含文件名的参数值
    :return: argparse 解析后的Namespace对象
    """
    if source is None:
        source = sys.argv[1:]
    args = None
    try:
        parse = argparse.ArgumentParser(prog="ExpDepos", conflict_handler='resolve')
        parse.add_argument("-V", "--version", help="显示版本信息并退出", dest="show_version",
                           action="store_true")
        parse.add_argument("--update", help="更新ExpDepos", dest="check_update",
                           action="store_true")
        parse.add_argument("-v", "--verbose", help="控制台信息输等级,该值越大输出信息越详细("
                                                   "0=ERROR|EXCEPTION,"
                                                   "1=SUCCESS|FAILED,"
                                                   "2=WARNING,"
                                                   "3=INFO,"
                                                   "4=DEBUG)",
                           default=Config['Console']['msgLevel'], choices=[0, 1, 2, 3, 4], type=int, dest="verbose")

        # target group
        target_group = parse.add_argument_group("target arguments")
        target_group.add_argument("-H", "--host", help="目标地址 (可选IP端口或URL地址)",
                                  dest="host", type=str)

        # module group
        mode_group = parse.add_argument_group("module arguments")
        mode_group.add_argument("-M", "--module", help="使用的Exploit模块(多个模块使用','分割)",
                                dest="module", type=str)
        mode_group.add_argument("-P", "--options", help="模块的用户自定义参数", dest="options", type=str)

        # module mode group
        module_mode = mode_group.add_mutually_exclusive_group()
        module_mode.add_argument("--info", help="显示模块详细信息", dest="show_info", action="store_true")
        module_mode.add_argument("--verify", help="以验证模式执行Exploit模块", action="store_true")
        module_mode.add_argument("--exploit", help="以利用模式执行Exploit模块", action="store_true")
        module_mode.add_argument("-h", "--help", help="显示Exploit模块帮助 与-M搭配使用",
                                 dest="module_help", action="store_true")

        args = parse.parse_args(source)
        # 校验必要参数
        if not any((args.show_version, args.host, args.module, args.check_update)):
            parse.print_help()
            exit()
        # 设置了host参数,则module参数是必须的
        if args.host and args.module is None:
            console.error("缺少必要参数([bold cyan]-M, --module[/bold cyan]). "
                          "请使用[bold cyan]-M[/bold cyan]或者[bold cyan]--module[/bold cyan]选项选择要运行的模块.")
            exit()
    except Exception as e:
        console.exception(repr(e))
    return args


def parse_options():
    """
    解析命令行参数

    :return:
    """
    # 解析 optional 参数
    if env.CliOptions.show_version:
        show_version()
    if env.CliOptions.check_update:
        check_update()
