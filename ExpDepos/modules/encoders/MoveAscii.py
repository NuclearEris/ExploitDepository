#!/usr/bin/env python

"""
@Author: Castiel
@Email:  ca3tie1@gmail.com
@Blog:   https://ca3tie1.github.io
@Git:    https://github.com/ca3tie1
@Wechat: Ca5tie1
@Date:   2021/12/14 10:43
"""

from ExpDepos.libs.core.base.EncodeBase import *


class MoveAscii(EncodeBase):
    Name = "move ascii"  # encoder名称
    Alias = "mvascii"  # encoder别名
    Author = "Castiel"  # 编写作者
    Create_Date = "2021-12-14"  # exp编写日期
    Update_Date = "2021-12-14"  # exp更新日期
    Rank = RANK.Normal  # exp效果(可选：Excellent Great Good Normal Average Low Manual)
    Desc = "位移ascii字符"
    Description = "依次对payload特定字符向左或者向右移位的加密方式，不常用但有时候会遇到。"

    def _options(self):
        options = dict()
        options["dir"] = OptString("right", description="移动方向，向左(left)或者向右(right)", choices=['left', 'right'])
        options["step"] = OptInteger(1, description="移动步长，默认1")
        options["l_skip"] = OptInteger(2, description="忽略开头字符长度")
        options["r_skip"] = OptInteger(2, description="忽略末尾字符长度")
        return options

    def _encode(self, payload: any([str, bytes])) -> any([str, bytes]):
        if isinstance(payload, bytes):
            payload = payload.decode("UTF_8")
        move_list = list()
        i = 1
        payload_len = len(payload)
        for char in payload:
            if self.get_option("l_skip") < i < payload_len - self.get_option("r_skip"):
                ascii_value = ord(char)
                if self.get_option("dir") == "right":
                    ascii_value += self.get_option("step")
                else:
                    ascii_value -= self.get_option("step")
                move_list.append(chr(ascii_value))
            else:
                move_list.append(char)
            i += 1
        return "".join(move_list)
