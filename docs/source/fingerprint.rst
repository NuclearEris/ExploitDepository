指纹编写
========

``ExpDepos`` 指纹库使用 ``YAML`` 语言编写，我们提供了两种方式来编写指纹。第一种是直接使用 ``YAML`` 语法在 ``ExpDepos/modules/fingerprints`` 下创建指纹库文件。第二种是在模块开发时候使用 ``Python`` 字典数据结构编写指纹，编写好的指纹将自动转换成 ``YAML`` 格式存放。

.. note::
    要编写指纹请 :doc:`点击此处 <fingerprinttpl>` 下载对应指纹模板，推荐在模块开发过程中为其编写对应指纹。

在模块中编写
------------

要在模块中编写指纹，需要继承模块基类的 ``_fingers`` 函数，在该函数中返回一个指纹信息字典，如下代码所示：

::

        def _fingers(self):
            """
            当前模块指纹定义

            :return: dict
            """
            fingerprint = {
                "name": self.AppName,                           # 漏洞应用名作为指纹名称
                "author": self.Author,                          # 作者
                "version": "1.0",                               # 版本号
                "type": FINGERPRINT.FP_TYPE.WEBAPP,             # 指纹类型 详情请参考指纹类型表
                "logic": "or",                                  # 匹配逻辑 默认为 or
                "description": "指纹描述信息",                    # 描述信息
                "website": "https://www.tongda2000.com/",
                "filters": {                                    # 过滤属性，用于从操作系统平台、中间件、和脚本语言3个维度进行过滤
                    "platform": ['windows', 'Unix'],
                    "middleware": ['apache', 'nginx'],
                    "language": ['PHP']
                },
                "matches": [{"url": "/tongda.ico?r={randstr()}", "hash": -759108386, "certainty": 100, "status": 200},
                            {"search": "headers", "keyword": "X-Powered-By: PHP/7.2.24-0ubuntu0.18.04.8"},
                            {"search": "headers[set-cookie]", "regex": "(aa)", "offset": 1, "version": "2.2",
                             "aim": "version"},
                            {"name": "matchName", "keyword": "test <||> referer"},
                            {"status": 200}],
                "sets": {                                       # 主动式匹配的一些HTTP Request设置
                    "headers": {"testHeader": "testHeader{randstr(10)}"},
                    "cookies": {"cname": "cValue{randstr(5,true)}"},
                    "params": {"test": "bbbb"},
                    "data": ""
                }
            }
            return fingerprint

指纹属性
--------

一个指纹由基本信息( ``name`` 、 ``author`` 等)、过滤属性( ``filters`` )、匹配项( ``matches`` )、设置( ``sets`` )组成，以下为全部属性释义：

    - ``name``      指纹名称，在模块中可以使用漏洞应用作为指纹名称。
    - ``author``    指纹作者信息。
    - ``version``   指纹版本信息。
    - ``type``      指纹分类，详情参看 :doc:`指纹分类 <fptype>` 定义。
    - ``logic``     指纹匹配项之间的匹配逻辑，可选 ``or`` 和 ``and`` 。
    - ``description``   指纹描述信息。
    - ``website``   指纹应用官网。
    - ``filters``   指纹过滤属性，用于从操作系统平台、中间件、和脚本语言3个维度进行过滤。
    - ``matches``   指纹匹配项，每一个匹配项为指纹匹配属性字典组成。
    - ``sets``      主动式匹配的一些HTTP请求设置，可设置 ``headers``、``cookies``、``params`` 和 ``data``。

matches
~~~~~~~

``matches`` 为多个匹配项组成的列表，每一个匹配项是由不同的匹配属性组成的匹配规则。以下为所有匹配属性释义：

    - ``name``      匹配项名称，该属性为可选属性。
    - ``url``       主动式匹配的标识，如果设置该属性则表示该匹配项需要主动请求该 ``url`` 进行指纹识别，没有该属性则为一个被动式匹配项。
    - ``search``    被动式匹配的标识，该属性值标识了被动式匹配区域，默认为 ``text``。可选区域有 ``headers`` (HTTP响应头)、``text`` (HTTP响应体)，``headers`` 区域亦可设置具体属性，例如 ``headers[set-cookie]`` 。
    - ``keyword``   关键词匹配，该属性标识该匹配项使用关键词进行匹配。
    - ``regex``     正则匹配，该属性标识该匹配项使用正则表达式进行匹配，值为一个正则表达式。
    - ``offset``    正则匹配结果索引值，该属性搭配 ``regex`` 使用，如果匹配成功则返回 ``match`` 对象 ``group`` 属性的对应索引值，否则将返回整个 ``match`` 对象。
    - ``hash``      ``mmh3`` 值匹配，该属性标识该匹配项匹配响应体的 ``mmh3`` 值。
    - ``md5``       ``md5`` 值匹配，该属性标识该匹配项匹配响应体的 ``md5`` 值。
    - ``status``    HTTP状态码匹配，该属性标识该匹配项匹配HTTP状态码，针对主动式匹配项，默认会设置请求的URL状态码为 ``200``。
    - ``aim``       变量设置，该属性用于设置匹配成功后存储值的变量名称，该名称在匹配结果字典中以键值存在。
    - ``certainty`` 匹配准确度百分比，该属性标识该匹配项匹配成功后指纹识别的准确度。

多个匹配属性
>>>>>>>>>>>>

针对每一个匹配项可以同时设置多个匹配属性，比如一个主动匹配项在请求特定URL的同时需要满足状态码为 ``200`` ，或是一个被动模式匹配属性在满足 ``hash`` 值的同时需要满足 ``md5`` 值。设有多个匹配属性的匹配项只有在全部匹配属性均满足的条件下才算匹配成功。

::

    "matches": [{"url": "/tongda.ico}", "hash": -759108386, "certainty": 100, "status": 200},
                {"hash": -759108386, "md5": 1205af91d6b1638c23de1132ae0c7e0b}
                ]
多个匹配值
>>>>>>>>>>

针对 ``hash`` 和 ``md5`` 方式的匹配值还支持列表类型，可以对多个值进行匹配验证，只要值存在于列表中均为匹配成功。这对一个匹配项存在多个可能值的情况比较适用，如下所示:

::

    "matches": [{"url": "/tongda.ico}", "hash": [-759108386, -75326295], "status": 200},]

keyword匹配逻辑
>>>>>>>>>>>>>>>>

针对 ``keyword`` 关键词匹配属性可以使用 ``<||>`` 或是 ``<&&>`` 符号分割多个关键词，用于表达简单的关键词匹配逻辑，前者为逻辑 ``或`` 后者为逻辑 ``与``。 ``<||>`` 标识所分割的关键词只要有一个匹配成功则该匹配项即算匹配成功， ``<&&>`` 则需要所有关键词匹配成功才算匹配成功。

::

     "matches": [{"name": "matchName", "keyword": "test <||> referer"}]

使用随机字符
>>>>>>>>>>>>

要在主动式匹配的URL属性或是HTTP请求属性的任意位置使用随机字符可以使用 ``{randstr()}`` 标识，该标识将调用 ``randstr()`` 函数作为随机字符生成器。该函数可以接受 ``length`` 和 ``number`` 参数，前者用于设置随机字符串长度，后者用于表示是否只用数字。

::

    # 生成默认5位随机数字加大小写字母的随机字符
    {"url": "/tongda.ico?r={randstr()}", "hash": -759108386, "certainty": 100, "status": 200}
    # 生成10位纯数字随机字符
    {"url": "/tongda.ico?r={randstr(10, true)}", "hash": -759108386, "certainty": 100, "status": 200}

``randstr()`` 函数定义如下：

.. autofunction:: ExpDepos.libs.core.base.Fingerprint.randstr

sets
~~~~

``sets`` 属性用于设置主动式匹配项HTTP请求属性，配置值为一个字典类型，可配置属性如下所示：

    - ``headers``   HTTP 请求头设置。
    - ``cookies``   HTTP 请求头的cookie值。
    - ``params``    HTTP Query 参数值。

::

    "sets": {
                "headers": {"testHeader": "testHeader{randstr(10)}"},
                "cookies": {"cname": "cValue{randstr(5,true)}"},
                "params": {"test": "bbbb"},
                "data": ""
            }

filters
~~~~~~~

指纹过滤属性 ``filters`` 为在批量指纹识别中过滤不必要的指纹信息做条件支持，``filters`` 从操作 ``platform`` (系统平台)、 ``middleware`` (中间件) 和 ``language`` (脚本语言)3个维度进行过滤，以下为常用过滤值列表：

.. autoattribute:: ExpDepos.libs.core.common.Enums.ENUMS.PLATFORM
.. autoattribute:: ExpDepos.libs.core.common.Enums.ENUMS.MIDDLEWARE
.. autoattribute:: ExpDepos.libs.core.common.Enums.ENUMS.SCRIPT_LANGUAGE

